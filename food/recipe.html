<!DOCTYPE html>
<html>
    <head>
        <title>Recipes</title>
        <style>
            .frozen {
                color: blue;
            }
            img.catalyst {
                width: 32px;
            }
            td > ol {
                margin-top: 0;
            }
        </style>
    </head>
    <body>
        <a href="/food/add-recipe">Add Recipe</a>
        <input id="inFilter" type="text" placeholder="Filter recipes" onchange="setFilter()">
        <REPLACE id="ongoing"/>
        <input type="button" value="Start selected" onclick="startRecipe()">
        <REPLACE id="table"/>


        <script src="../_/js/bot-ws.js"></script>
        <script>
            function cbToggled(e) {
                console.log(e);
                var id = e.target.id;
                var inp = document.getElementById("delay-" + id);
                inp.style.display = e.target.checked ? "" : "none";
            }

            function containsFilter(td, str) {
                if(td.innerText.toLowerCase().indexOf(str) !== -1) return true;

                var unorderedList = td.children[0];
                for(let listItem of unorderedList.children) {
                    var attr = listItem.getAttribute("data-id");
                    if(attr.toLowerCase() == str) return true;
                }
                return false;
            }

            function setFilter() {
                console.log("Setting filter");
                var filter = document.getElementById("inFilter").value;
                if(filter) filter = filter.toLowerCase();
                const rows = document.getElementsByTagName("tr");

                for(let row of rows) {
                    const firstCell = row.children[0];
                    if(firstCell.tagName === "TD") {
                        if(filter) {
                            row.style.display = (containsFilter(firstCell, filter)) ? "" : "none";
                        } else {
                            row.style.display = "";
                        }
                    }
                }
            }

            function startRecipe() {
                var doing = {};
                var selects = document.getElementsByClassName("recipe-selects");
                for(let x of selects) {
                    if(x.checked) {
                        var offset = document.getElementById("delay-" + x.id);
                        console.log(x, offset);
                        doing[parseInt(x.id)] = parseInt(offset.value || 0);
                    }
                }
                console.log(doing);

                fetch(`/api/food/recipes`, {
                    method: 'PUT',
                    body: JSON.stringify(doing)
                }).then(function(resp) {
                    console.log(resp);
                    if(resp.ok) {
                        resp.text().then(function(t) {
                            window.location = `/food/ongoing-recipe?id=${t}`;
                        })
                    }
                }).catch(function(err) {
                    console.log(err);
                })
            }
            function deleteRecipe(id) {
                var x = prompt("Are you sure you want to delete this? Type yes to continue", "")
                if(x !== "yes")
                    return;
                fetch(`/api/food/recipe?id=${id}`, {method: "DELETE"}).then(function(resp) {
                    console.log(resp);
                    if(resp.ok) {
                        window.location.reload();
                    } else {
                        console.error(resp);
                    }
                }).catch(function(err) {
                    console.error(err);
                })
            }
            function editRecipe(id) {
                window.location.href = "/food/add-recipe?modifyId=" + encodeURIComponent(id);
            }
            function init() {
                WSC.initWS(`food-scan`, 5, function(msg) {
                    const data = JSON.parse(msg.data);
                    if(data.code) {
                        const inp = document.getElementById("inFilter");
                        inp.value = data.code;
                        console.log("Set to", data.code);
                        inp.dispatchEvent(new Event("change"));
                    }
                }, null, function(e) {
                    // reconnect limit reached
                    window.location.reload();
                });
            }
            init();
        </script>
    </body>
</html>