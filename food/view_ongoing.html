<!DOCTYPE html>
<html>
    <head>
        <title>Viewing Ongoing Recipe</title>
        <style>
            html, body, div {
                margin: 0;
                min-height: 100%;
            }
            h1 {
                font-size: 4em;
            }
            h2 {
                font-size: 3em;
            }
            h3 {
                font-size: 2em;
                margin: 0;
            }
            h1, h2, h3, p {
                margin: 0;
                padding: 0;
                text-align: center
            }
        </style>
    </head>
    <body>
        <div>
            <h1 id="desc"></h1>
            <h2 id="time"></h2>
            <h3 id="endsAt"></h3>

            <p><strong id="after"></strong></p>
            <table id="full">

            </table>
        </div>

        <script src="../_/js/food-ws.js"></script>
        <script>
            const ID = "<REPLACE id='id'/>";
            const descElem = document.getElementById("desc");
            const timeElem = document.getElementById("time");
            const endsAtElem = document.getElementById("endsAt");
            const afterElem = document.getElementById("after");
            const tableElem = document.getElementById("full");

            var fullEndsAt = 0;
            var countTo = 0;
            var timerInterval = null;
            var started = false;
            var done = false;
            var audio = null;

            var ALL = null;

            function pad(n, width, z) {
                z = z || '0';
                n = n + '';
                return n.length >= width ? n : new Array(width - n.length + 1).join(z) + n;
            }

            function setDone() {
                endsAtElem.innerText = "";
                timeElem.innerText = "Complete!";
                document.body.style.backgroundColor = "green";
                if(audio != null) {
                    audio.pause();
                    audio = null;
                }
            }

            function createTd(value, header = false, colspan = null) {
                var d = document.createElement(header ? "th" : "td");
                d.innerText = value;
                if(colspan)
                    d.colSpan = colspan;
                return d;
            }
            function createTr(header, ...values) {
                var tr = document.createElement("tr");
                for(let x of values) {
                    tr.appendChild(createTd(x, header));
                }
                return tr;
            }

            function setTable() {
                if(ALL !== null) {
                    tableElem.innerHTML = "";
                    var headerRow = createTr(true, "Step", "When", "Delta");
                    tableElem.appendChild(headerRow);

                    var last = 0;
                    for(let step of ALL) {
                        console.log(step);
                        var diffLast = step.diff - last;
                        tableElem.appendChild(createTr(false, step.description, formatTime(step.diff, true), formatTime(diffLast, true)));
                        last = step.diff;
                    }
                }
            }

            function getTime(secs) {
                var hours = Math.floor(secs / 3600);
                secs -= hours * 3600;

                var minutes = Math.floor(secs / 60);
                secs -= minutes * 60;
                return [hours, minutes, secs];
            }
            function formatTime(secs, full) {
                var arr = getTime(secs);
                var hours = arr[0];
                var mins = arr[1];
                var secs = arr[2];
                if(full) {
                    var f = "";
                    if(hours > 0) {
                        f += `, ${hours}h`;
                    }
                    if(mins > 0) {
                        f += `, ${mins}m`;
                    }
                    if(secs > 0) {
                        f +=  `, ${secs}s`;
                    }
                    if(f === "")
                        return "Now.";
                    return f.substring(2);
                } else {
                    return `${pad(hours, 2)}:${pad(mins, 2)}:${pad(secs, 2)}`;
                }
            }

            function updateTimer() {
                if(done) {
                    setDone();
                    return;
                }
                if(countTo === 0) return;
                var now = Date.now();
                var msDiff = countTo - now; 
                if(msDiff <= 0) {
                    timeElem.innerText = "00:00:00";
                } else {
                    timeElem.innerText = formatTime(Math.round(msDiff / 1000));
                }


                if(msDiff < 3000) {
                    document.body.style.backgroundColor = "red";
                    if(audio === null && started) {
                        audio = new Audio("/_/assets/alarm.mp3");
                        audio.loop = true;
                        audio.play();
                    }
                } else if(msDiff < 25000) {
                    document.body.style.backgroundColor = "orange";
                } else {
                    document.body.style.backgroundColor = null;
                }

            }

            function handleMsg(e) {
                const data = JSON.parse(e.data);
                console.log(data);
                if(data.done) {
                    done = true;
                    clearInterval(timerInterval);
                    timerInterval = null;
                    document.body.removeEventListener("click", handleNext);
                    setDone();
                } else {
                    if(audio) {
                        audio.pause();
                        audio = null;
                    }
                    const current = data.current;
                    descElem.innerText = current.description;
                    countTo = parseInt(current.at);
                    timerInterval = setInterval(updateTimer, 50);
                    started = !!data.started;
                    fullEndsAt = parseInt(data.end ?? 0);
                    var msDiff = fullEndsAt - Date.now();
                    if(msDiff < 0) {
                        endsAtElem.innerText = "Recalculating ends at..";
                    } else {
                        endsAtElem.innerText = "All done in " + formatTime(Math.round(msDiff / 1000), true);
                    }

                    if(data.next) {
                        afterElem.innerText = `Next: ${data.next.description}`;
                    }
                    ALL = data.steps;
                    setTable();
                }
            }
            function handleNext() {
                started = true;
                WSC.socket.send(JSON.stringify({"data": "next"}));
            }
            function init() {
                descElem.innerText = "...";
                timeElem.innerText = "??:??:??";
                WSC.initWS(ID, handleMsg);
                document.body.addEventListener("click", handleNext, true);
            }
            init();
        </script>
    </body>
</html>