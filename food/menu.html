<!DOCTYPE html>
<html>
    <head>
        <title>Menu</title>
        <style>
            .shared {
                border-left: 5px solid black;
                border-right: 5px solid black;
                text-align: center; 
                vertical-align: middle;
            }
            .manu {
                margin-right: 3px;
                background-color: rgb(56, 56, 255);
                border-radius: 5%;
                padding: 1px 3px 1px 3px;
            }
            .cbshare {
                position: fixed;
                right: 8px;
            }
            .shift-pressed .item:hover {
                color: red;
            }
            .today-row {
                background-color: rgb(67, 67, 255);
            }
            .already-exists {
                color: rgb(242, 0, 255);
                
            }
            .already-exists::before {
                content: "(duplicate) ";
            }
            .expired {
                background-color: red;
            }
        </style>
    </head>
    <body>
        <h1>Menu <REPLACE id='title'/></h1>
        <REPLACE id="table"/>

        <div id="editThings">
            <a href="/food/menu/new">New Menus</a>

            <br>
            <label>Search for items: </label> <input type="text" id="search" onchange="searchItems(event)"/>
            <ul id="searchResults">
            </ul>
                
        </div>

        <script>
            const EDITING = "<REPLACE id='edit'/>";
            const searchResults = document.getElementById("searchResults");
            document.getElementById("editThings").style.display = (!!EDITING) ? "" : "none";
            function selectMenu(id) {
                if(!EDITING) return;
                fetch(`/api/food/menu?id=${id}`, {
                    method: "POST"
                })
                .then(function(resp) {
                    if(resp.ok) {
                        window.location.reload();
                    } else {
                        alert("Failed!");
                    }
                }).catch(function(err) {
                    console.error(err);
                })
            }
            function formatDate(date) {
                var options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                return date.toLocaleDateString("en-US", options);
            }
            function getExistingItems() {
                var items = document.getElementsByClassName("item");
                var ls = {};
                for(var item of items) {
                    ls[item.getAttribute("data-id")] = item;
                }
                return ls;
            }
            function searchItems(event) {
                if(!EDITING) return;
                fetch(`/api/food/query`, {
                    method: "POST",
                    body: `query=${encodeURIComponent(event.target.value)}&sort=expires`,
                    headers: {
                        "Content-Type": "x-form-data"
                    }
                })
                .then(function(resp) {
                    resp.json().then(function(value) {
                        console.log(value);

                        var existingItems = getExistingItems();
                        console.log(existingItems);

                        searchResults.innerHTML = "";
                        var now = new Date();
                        for(let item of value) {
                            var existing = existingItems[item.id];

                            var div = document.createElement("li");
                            if(existing) {
                                div.classList.add("already-exists");
                            }
                            div.id = item.id + "-n";
                            var date = new Date(item.expires);
                            if(date < now) {
                                div.classList.add("expired");
                            }
                            var t = "";
                            if(item.manu) {
                                t = `(${item.manu}) `;
                            }
                            div.innerText = t + `${item.name} expires ${formatDate(date)}`;
                            div.setAttribute("draggable", "true");
                            div.setAttribute("data-id", item.id);
                            div.ondragstart = onDragStart;
                            searchResults.appendChild(div);
                        }
                    })
                }).catch(function(err) {
                    console.error(err);
                })
            }

            function onDragStart(event) {
                if(!EDITING) return;
                console.log(event);
                event.dataTransfer.setData("text", event.target.id);
            }
            function onDragOver(event) {
                if(!EDITING) return;
                if(event.target.tagName === "TR") {
                    console.log(event);
                } else {
                    event.preventDefault();
                }
            }
            function toggleShare(event) {
                if(!EDITING) return;
                var td = event.target.parentElement;
                var tr = td.parentElement;
                fetch(`/api/food/menu/shared?day=${tr.id.split('-')[1]}`, {
                    method: "POST"
                })
                .then(function(resp) {
                    if(resp.ok) {
                        window.location.reload();
                    } else {
                        alert("Failed!");
                    }
                }).catch(function(err) {
                    console.error(err);
                })
            }
            function getTd(elem) {
                if(elem === null) return null;
                if(elem.tagName === "TD") return elem;
                return getTd(elem.parentElement);
            }

            function onItemClick(event)  {
                if(!EDITING) return;
                console.log(event);
                var thing = getTd(event.target);
                var curTarget = event.currentTarget;
                if(event.ctrlKey) {

                    var uses = parseInt(prompt("How many uses?", curTarget.getAttribute("data-uses")));
                    fetch(`/api/food/menu/item?day=${thing.getAttribute("data-date")}&group=${thing.getAttribute("data-group")}&id=${curTarget.getAttribute("data-id")}&uses=${uses}`, {
                        method: "PATCH"
                    })
                    .then(function(resp) {
                        if(resp.ok) {
                            window.location.reload();
                        }
                    }).catch(function(err) {
                        console.error(err);
                    })

                } else if(event.shiftKey) {
                    fetch(`/api/food/menu/item?day=${thing.getAttribute("data-date")}&group=${thing.getAttribute("data-group")}&id=${curTarget.getAttribute("data-id")}`, {
                        method: "DELETE"
                    })
                    .then(function(resp) {
                        if(resp.ok) {
                            curTarget.parentElement.removeChild(curTarget);
                        } else {
                            alert("Failed!");
                        }
                    }).catch(function(err) {
                        console.error(err);
                    })
                }
            }

            function onDrop(event) {
                if(!EDITING) return;
                const data = event.dataTransfer.getData("text");
                const fromElem = document.getElementById(data);
                const toElem = getTd(event.target);
                console.log(fromElem, "->", toElem);
                var fromGroup = fromElem.parentElement.getAttribute("data-group");
                var fromDay = fromElem.parentElement.getAttribute("data-date");
                var toGroup = toElem.getAttribute("data-group");
                var toDay = toElem.getAttribute("data-date");

                const evData = {
                    "toDay": toDay,
                    "toGroup": toGroup,
                    "id": fromElem.getAttribute("data-id"),
                    "uses": 1
                };
                if(fromGroup) {
                    evData.fromGroup = fromGroup;
                } else {
                    evData.uses = parseInt(prompt("How many uses will this use?", "1"));
                }
                if(fromDay)
                    evData.fromDay = fromDay;

                console.log(evData);
                
                fetch(`/api/food/menu/move`, {
                    method: "POST",
                    body: JSON.stringify(evData),
                    headers: {
                        "Content-Type": "application/json"
                    }
                })
                .then(function(resp) {
                    if(resp.ok) {
                        toElem.appendChild(fromElem);
                    } else {
                        resp.body().then(function(err) {
                            alert(err);
                        })
                    }
                }).catch(function(err) {
                    console.error(err);
                })
            }
        </script>
    </body>

</html>