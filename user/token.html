<!DOCTYPE html>
<head>
    <title>Tokens of <REPLACE id="user.name"/></title>
    <style>
        .hide {
            background: black;
            color: black;
        }

        .hide:hover {
            background: white;
        }

        .error {
            background: red;
            border: red 1px;
            color: white;
        }

        table {
                border-collapse: collapse;
                width: 100%;
                border: 1px solid #ddd;
                font-size: 18px;
            }
    
        #tTable th, #tTable td {
            text-align: left;
            padding: 12px;
        }

        #tTable tr {
            border-bottom: 1px solid #ddd;
        }

        #tTable tr.header, #tTable tr:hover {
            background-color: #f1f1f1;
        }

        input {
            margin-left: 2px;
        }

        #sTable tr td {
            align-content: center;
        }
    </style>
</head>
<body>
    <table id='tTable'>
        <tr><th>Name</th><th>Token</th><th>Scopes</th></tr>
        <REPLACE id="tokentable"/>
    </table>
    
    <div>
        <p>To generate a new token (or re-generate an existing one) type its name then hit <strong>Enter</strong></p>
        <input type='text' onkeyup="submitNewToken(this, event);" placeholder="Token name.."/>
    </div>

    <div>
        <p>Calculate the scopes needed:</p>
        <input id='output' type='number' readonly placeholder="Toggle checkboxes.."/>
        <table id='sTable'>
            <tr><th colspan="3">User scopes</th></tr>
            <tr>
                <td><input class='user' onclick="changedScopes('user', this);" type='checkbox' id='1'/><p>Read</p></td>
                <td><input class='user' onclick="changedScopes('user', this);" type='checkbox' id='3'/><p>Write</p></td>
                <td><input class='user' onclick="changedScopes('user', this);" type='checkbox' id='7'/><p>Admin</p></td>
            </tr>
            <tr><th colspan="3">Store scopes</th></tr>
            <tr>
                <td><input class='store' onclick="changedScopes('store', this);" type='checkbox' id='8'/><p>Read</p></td>
                <td><input class='store' onclick="changedScopes('store', this);" type='checkbox' id='24'/><p>Write</p></td>
                <td><input class='store' onclick="changedScopes('store', this);" type='checkbox' id='56'/><p>Admin</p></td>
            </tr>
        </table>
    </div>

    <script>
        function submitScope(input, event) {
            if(event.key != 'Enter') {
                return;
            }
            var scopeName = input.id.replace(/scope-/g, "");
            console.log(scopeName);
            fetch(`/user/tokens/scope?name=${scopeName}&scope=${input.value}`, {"method": "PUT"})
            .then(function(response) {
                if(response.ok) {
                    alert("Scope has been updated");
                    window.location.replace(window.location);
                } else {
                    input.classList.add("error");
                    response.text().then(function(text) {
                        alert(text);
                    });
                }
            }).catch(function(reason) {
                alert("Error:" + reason);
            });
        }
        
        function submitNewToken(input, event) {
            if(event.key != "Enter") {
                return;
            }
            var name = input.value;
            input.classList.remove("error");
            if(name.includes(" ")) {
                alert("Name cannot contain a space.");
                input.classList.add("error");
            }
            fetch(`/user/tokens?name=${name}`, {"method": "PUT"})
            .then(function(response) {
                if(response.ok) {
                    alert("Added new token");
                } else {
                    input.classList.add("error");
                    response.text().then(function(text) {
                        alert(text);
                    });
                }
            }).catch(function(reason) {
                alert("Error:" + reason);
            });
        }

        function calc() {
            let SCOPE = 0;
            var docs = document.getElementsByTagName("input");
            for(let element of docs) {
                if(element.type === "checkbox") {
                    console.log(element);
                    if(element.checked) {
                        SCOPE = SCOPE ^ parseInt(element.id);
                    }
                }
            }
            document.getElementById("output").value = SCOPE;
        }

        function changedScopes(type, input) {
            var checkboxes = document.getElementsByClassName(type);
            console.log(checkboxes);
            console.log(checkboxes.length);
            for(element of checkboxes) {
                console.log(element);
                if(element.id != input.id) {
                    element.checked = false;
                }
            }
            calc();
        }
    </script>
</body>