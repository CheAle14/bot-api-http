<!DOCTYPE html>
<html>
    <head>
        <title>Edit filter</title>
        <style>
            div {
                width: 100%;
            }
            #container {
                height: 100%;
                width: 100%;
            }
            #top-bit {
                height: 10%;
            }
            #bottom-bit {
                height: 50%;
            }
            #text {
                width: 100%;
                height: 100%;
            }
            input[value="Delete"] {
                background-color: rgb(255, 0, 0);
            }
            input[value="Copy"] {
                background-color: rgb(0, 255, 55);
            }
            input[type="button"] {
                width: 24%;
                height: 2em;
            }
            textarea.dirty {
                background-color: rgb(61, 61, 255);
            }
            #template {
                width: 100%;
                height: 5em;
            }
        </style>
    </head>
    <body>
        <div id="container">
            <div id="top-bit">
                <h1>Filter:</h1>
                <textarea id="template" onkeyup="dirty(event)" onchange="saveTemplate()"></textarea>
                <br/>
                <input type="button" value="Save" onclick="save()">
                <input type="button" value="Add" onclick="addnew()">
                <input type="button" value="Delete" onclick="del()">
                <input type="button" value="Copy" onclick="cpy()">
            </div>
            <hr>
            <div id="bottom-bit">
                <textarea id="text" onkeyup="dirty(event)"></textarea>
            </div>
        </div>
        

        <script>
            var textarea = document.getElementById("text");
            var temptext = document.getElementById("template");
            function getId() {
                return window.location.pathname.substring(window.location.pathname.lastIndexOf('/') + 1);
            }
            function dirty(event) {
                var text = event.srcElement;
                text.classList.add("dirty");
            }
            async function load() {
                const ID = getId();
                var response = await fetch(`/filters-raw/${ID}`);
                var body = await response.text();
                if(!response.ok) {
                    console.error("Error: ", response, body);
                    textarea.value = ":Error: " + body;
                } else {
                    textarea.value = body;
                }

                var temr = await fetch(`/filters-template/${ID}`);
                var temp = await temr.text();
                temptext.value = temp;
                if(!temr.ok) {
                    console.error("Error: ", temr, temp);
                }
            }
            async function addnew() {
                var template = temptext.value;
                var url = prompt("Enter URL:");
                if(url) {
                    var date = new Date().toISOString()
                    textarea.value += "\r\n\r\n" + String.format(template, date, url) + "\r\n!";
                    await save();
                }
            }
            async function saveText(text, url) {
                const ID = getId();
                text.setAttribute("readonly", "")
                var response = await fetch(`/filters-${url}/${ID}`, {
                    method: "POST",
                    body: text.value
                });
                var body = await response.text();
                if(!response.ok) {
                    console.error("Error: ", response, body);
                    alert("Failed to save!");
                } else {
                    text.removeAttribute("readonly");
                    text.classList.remove("dirty");
                }
            }
            async function save() {
                await saveText(textarea, "raw")
            }
            async function saveTemplate() {
                await saveText(temptext, "template")
            }
            async function del() {
                if(confirm("Are you sure you wish to delete?")) {
                    var response = await fetch("/filters/" + getId(), {
                        method: "DELETE"
                    });
                    if(response.redirected) {
                        window.location.href = response.url;
                    }
                }
            }
            async function cpy() {
                var name = window.location.href.replace('/filters/', '/filters-raw/');
                await navigator.clipboard.writeText(name);
            }
            load();
        </script>
    </body>
</html>